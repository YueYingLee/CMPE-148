<!-- TO DO: DISPLAY MESSAGES + MAKE CHAT WINDOW (?) + DISPLAY SENT MESSAGE-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">

{% extends 'base.html' %} {% block content %}
<div id="home-container">
  {% if error %}
  <p id="error">{{error}}</p>
  {% endif %}

  <header class="mb-auto">
    <div>
        <h3 class="float-md-start mb-0"> Title </h3>
        <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link active" aria-current="page" href="/homepage">Home</a>
            <a class="nav-link" href=""> About </a>
            <a class="nav-link" href="/logout"> Sign Out</a>
        </nav>
    </div>
 </header>

 <div class="sidebar">
  <h3 class="title"> Conversations </h3>
  <div class="convo-holder">
    {%for conversation in user_conversations%}
    <a class="convo-nav-link" href="/conversation/conversation_id={{conversation.conv_id}}"> {{conversation.participants}} </a>
    {% endfor %}
  </div>
  
</div>
 <div class="cover-container d-flex w-100 h-100 p-3 mx-auto" id="conversation"> 

  <h3 class = "title-header"> Conversation with {{participants}}</h3>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-danger">
      <ul class="list-unstyled">
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% endwith %}
        
    <script type="text/javascript">
      var socketio = io.connect("http://127.0.0.1:5000/")
      //var socketio = io();
      function joinConversation(conversationId) {
            socketio.emit('join_room', {conversation_id: "{{conversation_id}}", user: "{{user.username}}"});
        }
      joinConversation();

      socketio.on("message", function(message){
        createChatItem(message['message'], message['sender_name'], message['timestamp'])
      })
      
      function createChatItem(message, sender, timestamp){
          var messages = document.getElementById("messages")
          const content = `
          <p class = "msg"> ${sender} @ ${timestamp}: ${message}
          <br> 
          <br>
          `
          messages.innerHTML+= content
          }

    </script>

      <div class="message-container" id="messages">
        {%for message in decrypted_messages%}
          <script type="text/javascript">
            createChatItem("{{message['message']}}", "{{message['sender_name']}}", "{{message['timestamp']}}")
          </script>
        {% endfor %}
      </div>

      
          <div id="message-box">
            <input type="text" placeholder="Enter your message" id="message-input" name="message" />
            <button type="submit" id="send-btn" onclick="sendMessage()">Send</button>
          </div>


      <script type="text/javascript">
        function sendMessage() {
          //getting message input
          var msgInput = document.getElementById("message-input");
          //no input
          if (msgInput.value === "") return;
          //get the message, then "emit" a message event for the backend 
          var msg = msgInput.value;
          socketio.emit("message", { message: msg, conversation_id: "{{conversation_id}}", username: "{{user.username}}"});
          msgInput.value = "";
        }
      </script>
        <div class = "user-list">
            <div class = "user-online">
              <p class = "online user-item">Online</p>
              <div class = online-text>
                <ul id="onlinelist"></ul>
                <script type="text/javascript">
                  var socketio = io.connect("http://192.168.0.195:5000");

                  /*socketio.on('connect', function () {
                    console.log('Connected to the server');
                  });*/

                  /*socketio.on('updateUsers',function(data) {
                    console.log('received updateUsers: ', data);
                    updateOnlineUsersList(data);
                  });

                  function updateOnlineUsersList(usersData) {
                    var onlineList = document.getElementById('onlinelist');
                    onlineList.innerHTML = '';

                    for (var userId in usersData) {
                      var status = usersData[userId];
                      console.log('logged: ' + status);
                      var listItem = document.createElement('li');
                      listItem.innerText = userId + ' - ' + usersData[userId];
                      onlineList.appendChild(listItem);
                    }
                  }*/
                  function get_online_users() {
                    //convert dictionary to array
                      var userData = {{ connected_users|tojson|safe }};
                      //var parsedUserData = JSON.parse(userData);

                      //debugging: check to see if each key-value was passed
                      for (var key in userData) {
                          if (userData.hasOwnProperty(key)) {
                              console.log('key: ', key, 'value: ', userData[key]);
                          }
                      }
                      //add to onlinelist element
                      var onlineList = document.getElementById('onlinelist');
                      onlineList.innerHTML = '';
                      
                      //logged in user doesn't get passed so i manually add them into the online list
                      var currUser = document.createElement('li');
                      currUser.innerText = "{{user.username}}";
                      currUser.classList.add('online-user');
                      onlineList.appendChild(currUser);

                      //add each key (username) in the dictionary to the online list
                      for (var key in userData) {
                          var listItem = document.createElement('li');
                          listItem.innerText = key;
                          listItem.classList.add('online-user');
                          onlineList.appendChild(listItem);
                      }
                    }
                      
                    get_online_users();
                </script>
                </div>
            </div>
            <div class = "user-offline">
              <p class = "offline user-item">Offline</p>
              <div class = "offline-text">
              <ul id="offlinelist"></ul>
              <script type="text/javascript">
                //similar code as online list above
                var socketio = io.connect("http://192.168.0.195:5000");
                function get_offline_users() {
                    var userData = {{ connected_users|tojson|safe }};
                    var offlineList = document.getElementById('offlinelist');
                    offlineList.innerHTML = '';

                    //get string of participants and delimit using comma
                    var participants = "{{participants}}";
                    var userArray = participants.split(',');

                    //compare each participant in the conversation against the users in the connected_users dict
                    for (var i = 0; i < userArray.length; i++) {
                      //checks if participant is not in the connected_users list; also manually excludes current user
                      if((!(userData.hasOwnProperty(userArray[i]))) && userArray[i] != "{{user.username}}"){
                        var listItem = document.createElement('li');
                        listItem.innerText = userArray[i];
                        listItem.classList.add('offline-user');
                        offlineList.appendChild(listItem);
                    }
                  }
                }
                get_offline_users();
              </script>
              </div>
            </div>
        </div>
    </div> 
    </div>
</div>
{% endblock %}